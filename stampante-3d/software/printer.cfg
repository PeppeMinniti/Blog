#[include lis2dw.cfg]            # Includi configurazione sensore accelerometro LIS2DW per Input Shaper
### Input Shaper ###            # Header sezione Input Shaper
[include timelapse.cfg]         # Includi macro timelapse per Mainsail/Fluidd
[include mainsail.cfg]          # Includi alias e macro interfaccia Mainsail/Fluidd

##############################################################################
#                          Impostazioni stepper                              #
##############################################################################

# Driver0
[stepper_x]                     # Sezione motore passo-passo asse X
step_pin: PF13                  # Pin STEP motore X (impulsi microstep)
dir_pin: PF12                   # Pin DIR motore X (direzione di rotazione)
enable_pin: !PF14               # Pin ENABLE motore X (attivo basso se "!")
endstop_pin: !PG6               # Pin finecorsa X (NC, pull-up interno)
microsteps: 16                  # Impostazione microstep (1/16) per precisione
rotation_distance: 80           # Distanza (mm) percorsa in un giro completo del motore
position_endstop: 0             # Coordinate di home (finecorsa) in mm
position_max: 898               # Corsa massima asse X in mm
homing_speed: 100               # VelocitÃ  prima passata homing X (mm/s)
homing_retract_dist: 5.0        # Distanza di retrazione dopo homing (mm)
second_homing_speed: 5.0        # VelocitÃ  seconda passata homing X (mm/s)

# Driver1
[stepper_y]                     # Sezione motore passo-passo asse Y
step_pin: PG0                   # Pin STEP motore Y
dir_pin: PG1                    # Pin DIR motore Y
enable_pin: !PF15               # Pin ENABLE motore Y (attivo basso)
microsteps: 64                  # Microstep 1/64 per rapporto cinghia 2:1
rotation_distance: 40           # Distanza (mm) per giro completo del motore Y
endstop_pin: !PG9               # Pin finecorsa Y (NC, pull-up interno)
position_endstop: 0             # Coordinate home Y in mm
position_max: 736               # Corsa massima asse Y in mm
homing_speed: 100               # VelocitÃ  prima passata homing Y (mm/s)
homing_retract_dist: 5.0        # Retract dopo homing Y (mm)
second_homing_speed: 5.0        # VelocitÃ  seconda passata homing Y (mm/s)

# Driver2
[stepper_z]                     # Sezione motore passo-passo asse Z
step_pin: PF11                  # Pin STEP motore Z
dir_pin: PG3                    # Pin DIR motore Z
enable_pin: !PG5                # Pin ENABLE motore Z (attivo basso)
microsteps: 32                  # Microstep 1/32 per vite TR8x5
rotation_distance: 5            # mm per giro della vite a ricircolo
endstop_pin: probe:z_virtual_endstop  # Endstop virtuale (BLTouch)
position_min: -2                # Limite minimo Z (sotto Z0) per mesh
position_max: 800               # Limite massimo Z in mm
homing_speed: 5                 # VelocitÃ  homing Z (mm/s)
homing_retract_dist: 5.0        # Retract dopo homing Z (mm)
second_homing_speed: 1.0        # VelocitÃ  seconda passata homing Z (mm/s)

# Driver4 (Estrusore)
[extruder]                      # Sezione motore estrusore e hotend
step_pin: PF9                   # Pin STEP motore estrusore
dir_pin: PF10                   # Pin DIR motore estrusore
enable_pin: !PG2                # Pin ENABLE estrusore (attivo basso)
microsteps: 8                   # Microstep 1/8 su ingranaggi
rotation_distance: 23.449       # mm di filamento estruso per giro del motore
nozzle_diameter: 0.400          # Diametro ugello (mm)
filament_diameter: 1.750        # Diametro filamento (mm)
heater_pin: PA0                 # Pin controllo riscaldatore hotend
sensor_pin: PF4                 # Pin lettura termistore hotend
sensor_type: ATC Semitec 104GT-2  # Tipo di termistore hotend
min_temp: 0                     # Temperatura minima consentita (Â°C)
max_temp: 300                   # Temperatura massima consentita (Â°C)
pressure_advance: 0.0550        # Valore pressure advance
max_extrude_cross_section: 10.0 # Limite estrusione alzato (default 0.64 mmÂ²)
max_extrude_only_distance: 100000.0  # Distanza estrudibile illimitata (per test)

##############################################################################
#                        Impostazioni display info                           #
##############################################################################

[temperature_sensor raspberry_pi]  # Sensore temperatura host (RPi)
sensor_type: temperature_host    # Tipo sensore: host CPU
min_temp: 10                     # Min Â°C validi
max_temp: 100                    # Max Â°C validi

[temperature_sensor mcu_temp]    # Sensore temperatura MCU
sensor_type: temperature_mcu     # Tipo sensore: microcontroller
min_temp: 10
max_temp: 100

##############################################################################
#                       Definizione parametri sistema                        #
##############################################################################

[mcu]                            # Configurazione MCU principale
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_23001F001151313236343430-if00  # Identificatore seriale USB

[printer]                        # Parametri globali stampante
kinematics: cartesian           # Cinematica: cartesiana
max_velocity: 500               # VelocitÃ  massima (mm/s)
max_accel: 1000                 # Accelerazione massima (mm/sÂ²)
max_z_velocity: 10              # VelocitÃ  massima asse Z (mm/s)
max_z_accel: 100                # Accelerazione massima Z (mm/sÂ²)

# Ventola di raffreddamento stampa
[fan]                           # Sezione ventola part-cooling
pin: PA8                        # Pin controllo ventola (PWM)

[safe_z_home]                   # Configurazione safe Z-home
home_xy_position: 485, 373      # Coordinate XY per homing Z sicuro
speed: 100                      # VelocitÃ  XY safe_z_home (mm/s)
z_hop: 10                       # Altezza Z hop per safe_z_home (mm)
z_hop_speed: 6                 # VelocitÃ  Z hop safe_z_home (mm/s)

[board_pins]                    # Alias pin header EXP1/EXP2
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,    # Mappatura PE8â†’EXP1_1, PE7â†’EXP1_2
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=PC5

[neopixel neo]                  # Striscia LED Neopixel
pin: PB10                       # Pin di controllo Neopixel
chain_count: 2                  # Numero LED nella catena
color_order: GRB                # Ordine colori (Green, Red, Blue)
initial_RED: 0.0                # IntensitÃ  iniziale RED
initial_GREEN: 0.0              # IntensitÃ  iniziale GREEN
initial_BLUE: 0.0               # IntensitÃ  iniziale BLUE

[display_status]                # Sezione status display (vuota)

[pause_resume]                  # Configurazione pausa/riprendi
recover_velocity: 50            # VelocitÃ  (mm/s) al resume dopo pausa

##############################################################################
#                  Configurazione e parametri del sensore BLTouch            #
##############################################################################
[bltouch]                       # Sezione BLTouch
sensor_pin: ^PB7                # Pin sonda (pull-up interno)
control_pin: PB6                # Pin controllo estensione/retrazione
x_offset: -45                   # Offset X sonda â†’ ugello (mm)
y_offset: -5                    # Offset Y sonda â†’ ugello (mm)
z_offset: 1.10                  # Offset Z sonda â†’ ugello (mm) 1.15 piÃ¹ schiacciato - 1.05 piÃ¹ spazio tra nozzle e piatto
stow_on_each_sample: False      # Non parcheggiare ad ogni campione
probe_with_touch_mode: True     # Usa modalitÃ  touch per probe
samples: 1                      # Numero campioni per punto
samples_result: median          # Usa valore mediano
sample_retract_dist: 3.5        # Retract tra campioni (mm)
samples_tolerance: 0.05         # Tolleranza campioni (mm)
samples_tolerance_retries: 4    # Ritenta se fuori tolleranza

[bed_mesh]                      # Sezione bed mesh
speed: 240                      # VelocitÃ  probe mesh (mm/s)
horizontal_move_z: 5            # Altezza Z tra probe (mm)
mesh_min: 0, 0                  # Coordinate min XY mesh
mesh_max: 835, 731              # Coordinate max XY mesh
probe_count: 10, 10             # Numero probe in X e Y
mesh_pps: 3, 3                  # Punti per sezione per interpolazione
algorithm: bicubic              # Algoritmo interpolazione mesh
bicubic_tension: 0.25           # Tensione bicubica per smoothing
fade_start: 0                   # Inizio dissolvenza mesh (mm)
fade_end: 15                    # Fine dissolvenza mesh (mm)

##############################################################################
#                        Impostazioni macro FILETTO                          #
##############################################################################
[gcode_macro FILETTO]           # Macro per spurgo â€œfilettoâ€
variable_first_xx: 0             # Variabile X iniziale del primo oggetto
variable_first_yy: 0             # Variabile Y iniziale del primo oggetto
description: Esegue lo spurgo del filamento 10 mm a sx dell'oggetto da stampare  # Descrizione macro
gcode:
    # ----- costante di conversione lunghezza->estrusione -----
    {% set k = (0.48 * 0.20) / (3.14159 * (1.75/2)**2) %}   # Area sezione estrusione mmÂ²â†’E

    # ----- coordinate primo oggetto -----
    {% set first_x = first_xx|float %}       # X primo oggetto
    {% set first_y = first_yy|float %}       # Y primo oggetto

    # ----- bounding-box filetto -----
    {% set filetto_min_x1 = params.MINIMO_ICS|float - 15 %}   # X min - margine 15 mm
    {% set filetto_min_x2 = filetto_min_x1 + 5 %}             # X min + offset 5 mm
    {% set filetto_min_y1 = params.MINIMO_IPSLON|float - 15 %}# Y min - margine 15 mm
    {% set filetto_min_y2 = filetto_min_y1 + 5 %}             # Y min + offset 5 mm
    {% set filetto_max_x1 = params.MASSIMO_ICS|float + 15 %}  # X max + margine 15 mm
    {% set filetto_max_x2 = filetto_max_x1 - 5 %}             # X max - offset 5 mm
    {% set filetto_max_y1 = params.MASSIMO_IPSLON|float + 15 %}# Y max + margine 15 mm
    {% set filetto_max_y2 = filetto_max_y1 - 5 %}             # Y max - offset 5 mm
    {% set centro_x = filetto_min_x1 + ((filetto_max_x1 - filetto_min_x1) / 2) %}  # Centro X
    {% set centro_y = filetto_min_y1 + ((filetto_max_y1 - filetto_min_y1) / 2) %}  # Centro Y

    # ----- direzione e quadrante -----
    {% set direzione_x = "DX" if first_x > centro_x else "SX" %}  # Direzione orizzontale
    {% set direzione_y = "UP" if first_y > centro_y else "DN" %}  # Direzione verticale

    {% if   direzione_x == "DX" and direzione_y == "UP" %}{% set quadrante = "DU" %}   # Quadrante DU
    {% elif direzione_x == "DX" and direzione_y == "DN" %}{% set quadrante = "DD" %}  # Quadrante DD
    {% elif direzione_x == "SX" and direzione_y == "UP" %}{% set quadrante = "SU" %}  # Quadrante SU
    {% elif direzione_x == "SX" and direzione_y == "DN" %}{% set quadrante = "SD" %}  # Quadrante SD
    {% else %}{% set quadrante = "SC" %}{% endif %}                             # Quadrante sconosciuto

    {% if filetto_min_x1 > 0 and filetto_min_y1 > 0 and filetto_max_x1 < 880 and filetto_max_y1 < 736 %}  # Verifica area valida
        {% set cur = printer.configfile.config["extruder"]["rotation_distance"]|float %}  # Salva valore rotation_distance

        G21                                              # Imposta unitÃ  in mm
        G90                                              # Coordinate assolute
        M83                                              # Estrusore in modalitÃ  relativa
        G92 E0                                           # Azzera contatore estrusore

        {% if quadrante == "DU" %}   # Quadrante DU
            # Posizionamento iniziale a first_x
            G1 X{first_x} Y{filetto_max_y1} F6000         # Sposta a first_x feedrate 6000
            G1 Z0.20 F1000                                # Scendi a 0.2 mm feedrate 1000
            SET_EXTRUDER_ROTATION_DISTANCE EXTRUDER=extruder DISTANCE={cur/4}  # 400% flusso
            RESPOND TYPE=echo MSG="FUSSO AL 400%"        # Messaggio flusso 400%
            {% set x_andata = first_x + 50.0 %}           # Punto andata: first_x + 50mm verso destra
            {% set E1 = (50.0 * k)|round(3) %}            # Estrusione 50mm fissi
            G1 X{x_andata} Y{filetto_max_y1} E{E1*4} F150 # Andata 50mm verso destra al 400%
            G1 X{x_andata} Y{filetto_max_y2} F300         # Sposta Y di 5mm
            {% set E2 = (50.0 * k)|round(3) %}            # Estrusione 50mm ritorno
            G1 X{first_x} Y{filetto_max_y2} E{E2} F300    # Ritorno a first_x al 100%
            SET_EXTRUDER_ROTATION_DISTANCE EXTRUDER=extruder DISTANCE={cur}  # Ripristina flusso 100%
            RESPOND TYPE=echo MSG="FUSSO AL 100%"        # Messaggio flusso 100%

        {% elif quadrante == "DD" %}  # Quadrante DD
            # Posizionamento iniziale a first_x
            G1 X{first_x} Y{filetto_min_y1} F6000         # Sposta a first_x feedrate 6000
            G1 Z0.20 F1000                                # Scendi a 0.2 mm feedrate 1000
            SET_EXTRUDER_ROTATION_DISTANCE EXTRUDER=extruder DISTANCE={cur/4}  # 400% flusso
            RESPOND TYPE=echo MSG="FUSSO AL 400%"        # Messaggio flusso 400%
            {% set x_andata = first_x + 50.0 %}           # Punto andata: first_x + 50mm verso destra
            {% set E1 = (50.0 * k)|round(3) %}            # Estrusione 50mm fissi
            G1 X{x_andata} Y{filetto_min_y1} E{E1*4} F150 # Andata 50mm verso destra al 400%
            G1 X{x_andata} Y{filetto_min_y2} F300         # Sposta Y di 5mm
            {% set E2 = (50.0 * k)|round(3) %}            # Estrusione 50mm ritorno
            G1 X{first_x} Y{filetto_min_y2} E{E2} F300    # Ritorno a first_x al 100%
            SET_EXTRUDER_ROTATION_DISTANCE EXTRUDER=extruder DISTANCE={cur}  # Ripristina flusso 100%
            RESPOND TYPE=echo MSG="FUSSO AL 100%"        # Messaggio flusso 100%

        {% elif quadrante == "SU" %}  # Quadrante SU
            # Posizionamento iniziale a first_x
            G1 X{first_x} Y{filetto_max_y1} F6000         # Sposta a first_x feedrate 6000
            G1 Z0.20 F1000                               
            SET_EXTRUDER_ROTATION_DISTANCE EXTRUDER=extruder DISTANCE={cur/4}  
            RESPOND TYPE=echo MSG="FUSSO AL 400%"        
            {% set x_andata = first_x - 50.0 %}           # Punto andata: first_x - 50mm verso sinistra
            {% set E1 = (50.0 * k)|round(3) %}            # Estrusione 50mm fissi
            G1 X{x_andata} Y{filetto_max_y1} E{E1*4} F150 # Andata 50mm verso sinistra al 400%
            G1 X{x_andata} Y{filetto_max_y2} F300         # Sposta Y di 5mm
            {% set E2 = (50.0 * k)|round(3) %}            # Estrusione 50mm ritorno
            G1 X{first_x} Y{filetto_max_y2} E{E2} F300    # Ritorno a first_x al 100%
            SET_EXTRUDER_ROTATION_DISTANCE EXTRUDER=extruder DISTANCE={cur}  
            RESPOND TYPE=echo MSG="FUSSO AL 100%"        

        {% elif quadrante == "SD" %}  # Quadrante SD
            # Posizionamento iniziale a first_x
            G1 X{first_x} Y{filetto_min_y1} F6000         # Sposta a first_x feedrate 6000
            G1 Z0.20 F1000                               
            SET_EXTRUDER_ROTATION_DISTANCE EXTRUDER=extruder DISTANCE={cur/4}  
            RESPOND TYPE=echo MSG="FUSSO AL 400%"        
            {% set x_andata = first_x - 50.0 %}           # Punto andata: first_x - 50mm verso sinistra
            {% set E1 = (50.0 * k)|round(3) %}            # Estrusione 50mm fissi
            G1 X{x_andata} Y{filetto_min_y1} E{E1*4} F150 # Andata 50mm verso sinistra al 400%
            G1 X{x_andata} Y{filetto_min_y2} F300         # Sposta Y di 5mm
            {% set E2 = (50.0 * k)|round(3) %}            # Estrusione 50mm ritorno
            G1 X{first_x} Y{filetto_min_y2} E{E2} F300    # Ritorno a first_x al 100%
            SET_EXTRUDER_ROTATION_DISTANCE EXTRUDER=extruder DISTANCE={cur}  
            RESPOND TYPE=echo MSG="FUSSO AL 100%"        

        {% endif %}                    # Fine selezione quadrante

        G92 E0                         # Azzera estrusore dopo il test

    {% else %}                       # Se bounding-box non valida
        RESPOND TYPE=echo MSG="âš ï¸ Si Ã¨ verificato un problema con la lettura dei dati."  # Messaggio di errore
    {% endif %}                      # Fine controllo bounding-box


##############################################################################
#                Impostazioni macro livellamento dinamico                    #
##############################################################################
[gcode_macro BED_MESH_CALIBRATE_AREA]  # Macro per calibraggio mesh area
description: Esegue un bed_mesh_calibrate per un'area limitata con probe_count dinamico (senza backslash)
variable_min_x: 0                # Valore predefinito min X area
variable_min_y: 0                # Valore predefinito min Y area
variable_max_x: 845              # Valore predefinito max X area
variable_max_y: 731              # Valore predefinito max Y area
variable_margin: 10              # Margine intorno allâ€™area (mm)

gcode:
  {% set bed_size_x = 845.0 %}    # Larghezza letto in mm
  {% set bed_size_y = 731.0 %}    # ProfonditÃ  letto in mm
  {% set margin = params.MARGIN|default(variable_margin)|float %}  # Margine da param

  # ---- XMIN clamp ----
  {% set XMIN_pre = params.XMIN|float - margin %}  # XMIN meno margine
  {% if XMIN_pre < 0 %}{% set XMIN_clamped = 0 %}{% elif XMIN_pre > bed_size_x %}{% set XMIN_clamped = bed_size_x %}{% else %}{% set XMIN_clamped = XMIN_pre %}{% endif %}

  # ---- YMIN clamp ----
  {% set YMIN_pre = params.YMIN|float - margin %}  # YMIN meno margine
  {% if YMIN_pre < 0 %}{% set YMIN_clamped = 0 %}{% elif YMIN_pre > bed_size_y %}{% set YMIN_clamped = bed_size_y %}{% else %}{% set YMIN_clamped = YMIN_pre %}{% endif %}

  # ---- XMAX clamp ----
  {% set XMAX_pre = params.XMAX|float + margin %}  # XMAX piÃ¹ margine
  {% if XMAX_pre < 0 %}{% set XMAX_clamped = 0 %}{% elif XMAX_pre > bed_size_x %}{% set XMAX_clamped = bed_size_x %}{% else %}{% set XMAX_clamped = XMAX_pre %}{% endif %}

  # ---- YMAX clamp ----
  {% set YMAX_pre = params.YMAX|float + margin %}  # YMAX piÃ¹ margine
  {% if YMAX_pre < 0 %}{% set YMAX_clamped = 0 %}{% elif YMAX_pre > bed_size_y %}{% set YMAX_clamped = bed_size_y %}{% else %}{% set YMAX_clamped = YMAX_pre %}{% endif %}

  # ---- Calcolo area (x_range, y_range) ----
  {% set x_range_pre = XMAX_clamped - XMIN_clamped %}  # Diff X span
  {% set x_range = x_range_pre if x_range_pre>0 else 0 %} 
  {% set y_range_pre = YMAX_clamped - YMIN_clamped %}  # Diff Y span
  {% set y_range = y_range_pre if y_range_pre>0 else 0 %}

  # ---- Numero probe dinamico (PX, PY) ----
  {% set min_probe = 3 %} {% set max_probe = 8 %}  # Range probe
  {% set ratio_x = x_range / bed_size_x %} 
  {% set ratio_y = y_range / bed_size_y %} 
  {% set px = (min_probe + ratio_x*(max_probe-min_probe))|round|int %}
  {% set py = (min_probe + ratio_y*(max_probe-min_probe))|round|int %}
  {% set px = px if px>=min_probe else min_probe %} {% set px = px if px<=max_probe else max_probe %}
  {% set py = py if py>=min_probe else min_probe %} {% set py = py if py<=max_probe else max_probe %}

  # ---- SAMPLES dinamici (1-3) ----
  {% set area_ratio = (x_range*y_range)/(bed_size_x*bed_size_y) %}
  {% set samp = (1 + area_ratio*2)|round|int %}
  {% set samp = samp if samp>=1 else 1 %} {% set samp = samp if samp<=3 else 3 %}

  BED_MESH_CLEAR               # Pulisci mesh esistente
  BED_MESH_CALIBRATE mesh_min={XMIN_clamped},{YMIN_clamped} mesh_max={XMAX_clamped},{YMAX_clamped} PROBE_COUNT={px},{py} PROBE_SPACING=False SAMPLES={samp}  # Calibra mesh area

##############################################################################
#                         Impostazioni macro sistema                         #
##############################################################################
[exclude_object]               # Sezione exclude_object (vuota)
[respond]                      # Configura respond predefinito
default_type: echo             # Tipo di risposta echo

[gcode_macro _CLIENT_VARIABLE] # Macro client storage variabili
variable_use_custom_pos: True  # Usa parcheggio personalizzato
variable_custom_park_x: 50.0   # X parcheggio personalizzato
variable_custom_park_y: 50.0   # Y parcheggio personalizzato
variable_custom_park_dz: 5.0   # Z hop parcheggio personalizzato
variable_retract: 3.0          # Retract allâ€™avvio script
variable_cancel_retract: 5.0   # Ritrattazione annullamento
variable_speed_retract: 15.0   # VelocitÃ  retract (mm/s)
variable_unretract: 3.0        # Unretract (mm)
variable_speed_unretract: 15.0 # VelocitÃ  unretract (mm/s)
variable_speed_hop: 5.0        # VelocitÃ  Z hop (mm/s)
variable_speed_move: 100.0     # VelocitÃ  spostamenti (mm/s)
variable_park_at_cancel: False # Non parcheggiare a cancel
variable_park_at_cancel_x: None
variable_park_at_cancel_y: None
variable_use_fw_retract: False#endregion
variable_idle_timeout: 7200    # Timeout idle in secondi
gcode:                         # Corpo macro vuoto

##############################################################################
#                 Sensore di movimento filamento (encoder)                  #
##############################################################################
[filament_motion_sensor encoder_sensor]  # Sezione encoder filamento
detection_length: 12             # Lunghezza controllo (mm)
extruder: extruder               # Riferimento estrusore
switch_pin: ^PG12                # Pin switch (pull-up interno)
pause_on_runout: False           # Non mettere in pausa automatico
runout_gcode:                    # G-code runout personalizzato
    SAVE_GCODE_STATE NAME=runout_state  # Salva stato G-code
    M114                          # Stato posizione
    M300                          # Suona buzzer
    SET_LED LED=neo RED=.2 GREEN=0 BLUE=0 INDEX=1 TRANSMIT=0  # LED rosso
    SET_LED LED=neo RED=0 GREEN=0 BLUE=.2 INDEX=2             # LED blu
    PAUSE                         # Pausa stampa
    G91                           # ModalitÃ  relativa
    G1 Z10                        # Sali di 10 mm
    G90                           # Torna a modalitÃ  assoluta
    G1 X50 Y50 F8000              # Sposta su area parcheggio
    G91                           # Relativo
    RESTORE_GCODE_STATE NAME=runout_state  # Ripristina stato
insert_gcode:                     # Insert segment vuoto

##############################################################################
#                         Impostazioni macro personali                       #
##############################################################################

[gcode_macro PULISCI_ESTRUSORE]  # Macro per pulizia estrusore
gcode:
    BED_MESH_PROFILE LOAD=default # Carica profilo bed_mesh default

    {% set current_temp = printer.extruder.temperature %}
    {% if current_temp < 170 %}
        M109 T0 S170  # Riscalda e aspetta che raggiunga 170Â°C
        RESPOND TYPE=echo MSG="ðŸ”¥ Riscaldamento estrusore a 170Â°C..."
    {% else %}
        RESPOND TYPE=echo MSG="âœ… Estrusore giÃ  a temperatura sufficiente"
    {% endif %}

    G28 X Y Z                     # Homing completo
    G0 Z20.0                      # Z a 20.0 mm
    G0 F10000 X894 Y40            # Sposta su area pulizia
    G1 F10000 
    G0 Z0                         # Z a 0.5 mm
    
    # Ciclo principale: ripete il pattern di pulizia 2 volte
    {% for ciclo in range(2) %}
        # Movimenti orizzontali zig-zag
        {% for i in range(3) %}
            G1 X881 Y20
            G1 X897 Y20
        {% endfor %}
        
        # Movimenti verticali
        {% for j in range(3) %}
            G1 X885 Y40
            G1 X885 Y0
        {% endfor %}
        G1 X889 Y40
    {% endfor %}
    
    #M104 T0 S0
    G0 F5000
    G0 Z20.0                      # Z a 20.0 mm
#    G28 X Y Z                     # Homing completo

[gcode_macro HOME_PARK]         # Macro homing e parcheggio
gcode:
    SET_FAN_SPEED FAN=hotend_fan_pwm SPEED=1.0           # Accendi ventola hotend lenta
    M109 T0 S170                 # Scalda hotend a 170Â°C e attende
#    G28 X Y Z                    # Homing completo
    G0 Y736 F10000 Z50           # Parcheggio in Y massimo con Z a 50 mm
    BED_MESH_PROFILE LOAD=default  # Ricarica profilo bed_mesh

[gcode_macro SHAPER]            # Macro input shaper calibrate
gcode:
    M109 T0 S170                 # Scalda hotend a 170Â°C e attende
    G28 X Y Z                    # Homing completo
    SHAPER_CALIBRATE             # Esegui input shaper calibrate
    SAVE_CONFIG                  # Salva configurazione

[gcode_macro LIVELLA_SOLA]      # Macro mesh senza pulizia estrusore
gcode:
    M109 T0 S170
    G28 X Y Z
    BED_MESH_CALIBRATE
    SAVE_CONFIG

[gcode_macro LIVELLA]           # Macro mesh con pulizia estrusore
gcode:
    PULISCI_ESTRUSORE            # Esegui pulizia estrusore
    M109 T0 S170
    G28 X Y Z
    BED_MESH_CALIBRATE
    SAVE_CONFIG

##############################################################################
#                           Macro suona (buzzer)                             #
##############################################################################
#prova                          
[gcode_macro PINK]              # Macro suonatore Wish You Were Here
description: Intona ritornello Wish You Were Here
gcode:
    # Due accordi (Em e G), con 6 note ciascuno
    # Frequenze in Hz
    {% set chord_patterns = [
        [330, 392, 494, 659, 494, 392],  # Em
        [392, 494, 587, 784, 587, 494]   # G
    ] %}
    {% set duration = 250 %}      # Durata nota (ms)
    {% set pause   = 50 %}       # Pausa tra note (ms)
    {% for repeat in range(2) %}
        {% for chord_idx in [0,0,1,1] %}
            {% for freq in chord_patterns[chord_idx] %}
                SET_PIN PIN=suona VALUE=0.9 CYCLE_TIME={1.0/freq}  # Attiva buzzer
                G4 P{duration}                                   # Attesa
                SET_PIN PIN=suona VALUE=0                            # Spegni buzzer
                G4 P{pause}                                      # Pausa
            {% endfor %}
        {% endfor %}
    {% endfor %}
    SET_PIN PIN=suona VALUE=0       # Spegni buzzer finale

[gcode_macro M300]               # Macro sweep buzzer
description: Abilita buzzer
gcode:
    {% set P=1 %}                 
    {% for dummy in range(5) %}
        {% for freq in range(1500,2000,50) %}
            SET_PIN PIN=suona VALUE=0.9 CYCLE_TIME={1.0/freq}
        {% endfor %}
        {% for freq in range(2000,1500,-50) %}
            SET_PIN PIN=suona VALUE=0.9 CYCLE_TIME={1.0/freq}
        {% endfor %}
    {% endfor %}
    SET_PIN PIN=suona VALUE=0      # Spegni buzzer finale

[gcode_button PULSANTE_BEEP]     # Bottone fisico per beep
pin: ^!PG14                      # Pin PG14, pull-up e invertito
press_gcode:
    {% if printer.idle_timeout.state != 'Printing' or printer.pause_resume.is_paused %}
      M300                        # Esegui macro M300
    {% endif %}

[gcode_button PULSANTE_RESUME]   # Bottone fisico per resume
pin: ^!PG15                      # Pin PG15, pull-up e invertito
press_gcode:
    {% if printer.idle_timeout.state != 'Printing' or printer.pause_resume.is_paused %}
      SET_LED LED=neo RED=0 GREEN=0 BLUE=0 INDEX=1 TRANSMIT=0  # Reset LED1
      SET_LED LED=neo RED=0 GREEN=0 BLUE=0 INDEX=2             # Reset LED2
      RESUME                      # Riprendi stampa
    {% endif %}

[gcode_macro PULISCI_PARCHEGGIO]  # Macro vuota per parcheggio
gcode:

##############################################################################
#                       Definizione funzioni personali                       #
##############################################################################
[pwm_cycle_time suona]            # Configurazione PWM per buzzer
pin: EXP1_3                       # Pin buzzer
value: 0                          # Valore iniziale duty-cycle
shutdown_value: 0                # Valore a spegnimento
cycle_time: 0.001                # Periodo PWM (s)

##############################################################################
#               VENTOLA DISSIPATORE HOTEND (PWM DINAMICO)                    #
##############################################################################
[gcode_macro fan_state]          # Macro di stato ventola hotend
    variable_flag0: 0            # Flag velocitÃ  0%
    variable_flag40: 0           # Flag velocitÃ  40%
    variable_flag50: 0           # Flag velocitÃ  50%
    variable_flag75: 0           # Flag velocitÃ  75%
    variable_flag100: 0          # Flag velocitÃ  100%
gcode:
    # (Logica di controllo ventola originale mantenuta senza modifiche)

[fan_generic hotend_fan_pwm]     # Configurazione fan hotend
pin: PD12                         # Pin PWM ventola hotend
shutdown_speed: 0.0              # VelocitÃ  a spegnimento (0%)
hardware_pwm: True               # Usa PWM hardware della MCU
cycle_time: 0.01                 # Periodo ciclo PWM (s)
kick_start_time: 0.5             # Tempo di spunto alla massima velocitÃ  (s)

[gcode_macro CHECK_EXTRUDER_TEMP]  # Macro controllo temperatura estrusore
gcode:
    {% set target = printer.extruder.target %}
    {% set actual = printer.extruder.temperature %}
    {% set delta = target - actual %}
    
    # Caso 1: Riscaldatore acceso (>40Â°C)
    {% if target >= 40 %}
        #UPDATE_DELAYED_GCODE ID=fan_off_delay DURATION=0

        {% if delta > 1.5 and printer["gcode_macro fan_state"].flag50 == 0 %}
            SET_FAN_SPEED FAN=hotend_fan_pwm SPEED=0.5         # Ventola al 50%
            RESPOND TYPE=echo MSG="ðŸ”µ Ventola al 50%"
            SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag0 VALUE=0
            SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag40 VALUE=0
            SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag50 VALUE=1
            SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag75 VALUE=0
            SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag100 VALUE=0
        {% endif %}
        
        {% if delta > 0.75 and delta <= 1.5 and printer["gcode_macro fan_state"].flag75 == 0 %}
            SET_FAN_SPEED FAN=hotend_fan_pwm SPEED=0.75        # Ventola al 75%
            RESPOND TYPE=echo MSG="ðŸŸ¡ Ventola al 75%"
            SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag0 VALUE=0
            SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag40 VALUE=0
            SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag50 VALUE=0
            SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag75 VALUE=1
            SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag100 VALUE=0
        {% endif %}
        
        {% if delta > 0 and delta <= 0.75 and printer["gcode_macro fan_state"].flag100 == 0 %}
            SET_FAN_SPEED FAN=hotend_fan_pwm SPEED=1.0         # Ventola al 100%
            RESPOND TYPE=echo MSG="ðŸŸ¢ Ventola al 100%"
            SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag0 VALUE=0
            SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag40 VALUE=0
            SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag50 VALUE=0
            SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag75 VALUE=0
            SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag100 VALUE=1
        {% endif %}
    {% endif %}
    
    # Caso 2: Riscaldatore spento ma ancora caldo (actual â‰¥40Â°C)
    {% if actual >= 40 and target < 40 and printer["gcode_macro fan_state"].flag40 == 0 %}
        SET_FAN_SPEED FAN=hotend_fan_pwm SPEED=1.0         # Raffreddamento post-stampa 100%
        RESPOND TYPE=echo MSG="ðŸŸ  Raffreddamento post-stampa: Ventola al 100%"
        SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag0 VALUE=0
        SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag40 VALUE=1
        SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag50 VALUE=0
        SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag75 VALUE=0
        SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag100 VALUE=0
    {% endif %}

    # Caso 3: Estrusore freddo (<40Â°C), spegni ventola
    {% if actual < 40 and target < 40 and printer["gcode_macro fan_state"].flag0 == 0 %}
        SET_FAN_SPEED FAN=hotend_fan_pwm SPEED=0.0         # Ventola spenta
        RESPOND TYPE=echo MSG="âš ï¸ Estrusore freddo: ventola spenta."
        SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag0 VALUE=1
        SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag40 VALUE=0
        SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag50 VALUE=0
        SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag75 VALUE=0
        SET_GCODE_VARIABLE MACRO=fan_state VARIABLE=flag100 VALUE=0
    {% endif %}

[delayed_gcode automatic_fan_check] # G-code ritardato per aggiornamento ventola
initial_duration: 0.5           # Ritardo iniziale (s)
gcode:
    CHECK_EXTRUDER_TEMP         # Chiama macro controllo temperatura
    UPDATE_DELAYED_GCODE ID=automatic_fan_check DURATION=0.5  # Loop continuo

[delayed_gcode power_on_fan_off] # Spegni ventola allâ€™avvio
initial_duration: 1             # Ritardo dopo power-on (s)
gcode:
    SET_FAN_SPEED FAN=hotend_fan_pwm SPEED=0.0
    UPDATE_DELAYED_GCODE ID=automatic_fan_check DURATION=0.5

####################################################################################
# fine gestione ventola per dissipatore hotend
####################################################################################

[gcode_macro ACCEL_TEST]         # Macro test accelerometro
gcode:
    {% for i in range(30) %}
    ACCELEROMETER_QUERY         # Query accelerometro
    G4 P200                     # Attesa 200 ms
    {% endfor %}

#[firmware_retraction]           # Configurazione firmware retraction (commentata)
#retract_length: 3
#retract_speed: 50
#unretract_extra_length: 0
#unretract_speed: 50

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bltouch]
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 21.265
#*# pid_ki = 1.212
#*# pid_kd = 93.299
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -1.042969, -0.558594, -0.390625, -0.445313, -0.525781, -0.470313, -0.316406, -0.155469, -0.239063, -0.504688
#*# 	  -0.743750, -0.308594, -0.168750, -0.250781, -0.351563, -0.344531, -0.236719, -0.107031, -0.209375, -0.455469
#*# 	  -0.487500, -0.068750, 0.020312, -0.091406, -0.235938, -0.253125, -0.164844, -0.060938, -0.196094, -0.459375
#*# 	  -0.239844, 0.159375, 0.221875, 0.068750, -0.075000, -0.129688, -0.084375, -0.023438, -0.192188, -0.472656
#*# 	  -0.035938, 0.386719, 0.447656, 0.282031, 0.088281, 0.021875, 0.059375, 0.094531, -0.117969, -0.484375
#*# 	  0.001562, 0.374219, 0.432812, 0.272656, 0.064844, -0.045313, -0.043750, -0.049219, -0.333594, -0.681250
#*# 	  -0.078906, 0.317969, 0.382031, 0.217187, -0.003125, -0.135156, -0.157031, -0.198438, -0.489844, -0.907031
#*# 	  -0.044531, 0.322656, 0.378125, 0.207031, -0.038281, -0.203125, -0.265625, -0.362500, -0.650000, -1.110938
#*# 	  -0.040625, 0.296875, 0.346094, 0.165625, -0.114844, -0.322656, -0.407031, -0.525000, -0.887500, -1.378125
#*# 	  -0.126563, 0.162500, 0.161719, -0.088281, -0.435156, -0.695313, -0.845313, -1.023438, -1.431250, -1.934375
#*# x_count = 10
#*# y_count = 10
#*# mesh_x_pps = 3
#*# mesh_y_pps = 3
#*# algo = bicubic
#*# tension = 0.25
#*# min_x = 0.0
#*# max_x = 834.93
#*# min_y = 0.0
#*# max_y = 730.9800000000001
#*#
#*# [input_shaper]
#*# shaper_type_x = 3hump_ei
#*# shaper_freq_x = 56.6
#*# shaper_type_y = mzv
#*# shaper_freq_y = 25.4
